<html>
<head>
<meta charset="UTF-8" />
<title>Current health of the caGrid</title>
<script src="http://cdn.jquerytools.org/1.2.5/full/jquery.tools.min.js"></script>
<!--
jquery tools already includes jquery 1.4.2
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
-->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery.ajaxmanager.js"></script>

<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.5.custom.css"/> 


<script type="text/javascript" charset="utf-8">
    
    var GSS_URL = "../..";
    var GSS_JSON_URL = GSS_URL+"/json";
    
    var lastRefreshDate = "";
    var services = null;
    var serviceById = {};
    var hosts = null;
    var hostById = {};
    
    function cmp(a,b,caseSensitive) {
        if (!a && !b) return 0;
        if (!a) return -1;
        if (!b) return 1;
        var ha = a.toLowerCase();
        var hb = b.toLowerCase();
        if (ha < hb) return -1;
        if (ha > hb) return 1;
        return 0;
    }
    
    function ccmp(a,b) {
        if (!a && !b) return 0;
        if (!a) return -1;
        if (!b) return 1;
        if (a < b) return -1;
        if (a > b) return 1;
        return 0;
    }
    
    function addCommas(nStr) {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? '.' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }
    
    function allDataReady() {
        return ((services != null) && (hosts != null));
    }
    
    function setup() {
    
        // add services to hosts
        for(i in services) {
            var service = services[i];
            var hostId = service.host_id ? service.host_id : '';
            var host = hostById[hostId];
            host.services[service['class']].push(service);
        }
        
        // sort services        
        services.sort(function(a,b) {
            var hosta = hostById[a.host_id];
            var hostb = hostById[b.host_id];
            if (!hosta && !hostb) return cmp(a.name, b.name);
            if (!hosta) return -1;
            if (!hostb) return 1;
            var c = cmp(hosta.long_name, hostb.long_name);
            if (c==0) return cmp(a.name, b.name);
            return c;
        });
        
        // sort hosts        
        hosts.sort(function(a,b) {
            return cmp(a.long_name, b.long_name);
        });
        
        for(var i=0; i<hosts.length; i++) {
            var host = hosts[i];
            
            // sort services at this host
            for(var type in host.services) {
                host.services[type].sort(function(a,b) {
                    return cmp(a.name, b.name);
                });
            }
        }
        
        createView("#DataService");
    }
    
    function createView(hash) {
    
        var type = hash.substring(1);
    
        var html = '<table class="grid"><tr>';
        html += "<th valign='bottom'><img src='images/grid_health_labels_host.png'></th>";
        html += "<th valign='bottom'><img src='images/grid_health_labels_name.png'></th>";
        html += "<th valign='bottom'><img src='images/grid_health_labels_version.png'></th>";
        html += "<th valign='bottom'><img src='images/grid_health_labels_index.png'></th>";
        html += "<th valign='bottom'><img src='images/grid_health_labels_access.png'></th>";
        if (type == 'DataService')
            html += "<th valign='bottom'><img src='images/grid_health_labels_counts.png'></th>";
        html += "</tr>";
        
        for(var i=0; i<hosts.length; i++) {
            var host = hosts[i];
            
            if (host.services[type].length == 0) continue;
            
            html += '<tr><td rowspan="'+host.services[type].length+'" title="'+host.long_name+'">'
            html += host.img+'</td>';
            
            for(var j=0; j<host.services[type].length; j++) {
                var service = host.services[type][j];
                var indexedImg = service.status == 'ACTIVE' ? 'tick.png' : 'exclamation.png';
                var accessImg = service.accessible == 'true' ? 'tick.png' : 'exclamation.png';
                var indexedTitle = service.status == 'ACTIVE' ? 'Service was found on the Index Service' : 'Service was not found on the Index Service';
                var accessTitle = service.accessible == 'true' ? 'Service WSDL was accessible' : 'Service WSDL was not accessible';
                
                if (j>0) html += '<tr>';
                html += '<td><a href="'+service.url+'?wsdl" target="_new">'+service.name+'</a></td>';
                html += '<td class="nowrap">'+service.version+'</td>';
                html += '<td title="'+indexedTitle+'"><img src="images/'+indexedImg+'" class="cellicon"/></td>';   
                html += '<td title="'+accessTitle+'"><img src="images/'+accessImg+'" class="cellicon"/></td>';
            
                if (type == 'DataService')
                    html += '<td id="counts_'+service.id+'" class="nopad">'
                          + '<div class="loading">Loading...</div></td></tr>';
            }
        }
        
        html += '</table>';
        html += '<div class="refreshDate">Last Refreshed: '+lastRefreshDate+'</div>';
        
        $('#'+type).empty().append(html);
        $('#'+type).data('loaded',1)
        if (type == 'AnalyticalService') return;
        
        var c = 0;
        for(i in services) {
            var service = services[i];
            if (service['class'] != "DataService") continue;
            var tdid = "counts_"+service.id;
            
            $.manageAjax.add('ajaxman', { 
                     dataType: "json",               
                     url: GSS_JSON_URL+"/counts?serviceId="+service.id,
                     success: function(json) {
                   
                    if (!("counts" in json)) return; 
                    var counts = json.counts;
                    var sid;
                    for (s in counts) sid = s;
                    var service = serviceById[sid];
                    var tdid = "counts_"+sid;
                    var classes = counts[sid];
                    
                    var classNames = [];
                    for(k in classes) {
                        classNames.push(k);
                    }
                    classNames.sort(function(a,b) {
                        var ca = a.substring(a.lastIndexOf('.')+1);
                        var cb = b.substring(b.lastIndexOf('.')+1);
                        var pa = a.substring(0,a.lastIndexOf('.'));
                        var pb = b.substring(0,b.lastIndexOf('.'));
                        var p = ccmp(pa,pb);
                        if (p != 0) return p;
                        return ccmp(ca,cb);
                    });
                
                    var tips = "";
                    var overlays = "";
                    var countHtml = '<table class="innergrid"><tr>';
                    for(var k=0; k<classNames.length; k++) {
                        var cellid = "_"+sid+"_"+k;
                        var className = classNames[k];
                        var cv = classes[className];
                        
                        var css = '';
                        var tip = '<div class="serviceName">'+service.name+'</div>'
                                + '<div class="className">'+className+'</div>';
                        var overlay = "";

                        if ('countDate' in cv) {
                            tip += 'Refreshed: <span class="tipvalue">'+cv['countDate']+'</span><br/>';
                            if ('count' in cv) {
                                css = cv.count == 0 ? 'good' : 'great';
                                tip += 'Number of instances: <span class="tipvalue">'+cv.count+'</span>';
                            } 
                            else if ('error' in cv) {
                                css = 'bad';
                                tip += 'Error: <span class="errors">'+cv.error+'</span>';
                                overlay += '<br/>Stacktrace: <pre></pre>';
                            }
                            else {
                                css = 'nullresult';
                                tip += 'The count query returned a null result.';
                            }
                        }
                        else {
                            css = 'unknown';
                            tip += 'This class was not queried for one of the following reasons:<ul>';
                            tip += '<li>The service is known to not support count queries';
                            tip += '<li>GSS encountered 10 query execution errors while querying this service';
                            tip += '<li>GSS encountered 2 service errors while querying this service';
                            tip += '</ul>';
                        }
                        
                        countHtml += '<td id="'+cellid+'" class="'+css+'" rel="#ol'+cellid+'">';
                        countHtml += '<div class="cell"></div></td>';
                        tips += '<div class="tooltip" id="tip'+cellid+'">'+tip+'</div>';
                        overlays += '<div class="overlay" id="ol'+cellid+'">'+tip+overlay+'</div>';
                    }
            
                    countHtml += '</tr></table>' + tips + overlays;
                    $('#'+tdid).empty().append(countHtml);
                    
                    for(var k=0; k<classNames.length; k++) {
                        var className = classNames[k];
                        var cellid = "_"+sid+"_"+k;
                        
                        $('#'+cellid).tooltip({ 
                                tip:"#tip"+cellid, 
                                delay:0, 
                                position: 'bottom right', 
                                relative: true
                        });
                        
                        $('#'+cellid).overlay({
                            mask: "grey",
                            onBeforeLoad: (function(className) { 
                                return function() {
                                    var oid = this.getOverlay().attr('id');
                                    $.manageAjax.add('ajaxman', { 
                                             dataType: "json",               
                                             url: GSS_JSON_URL+"/counts?serviceId="+service.id+"&className="+className,
                                             success: (function(oid) { 
                                                return function(json) {                                               
                                                    if (!("counts" in json)) return; 
                                                    var counts = json.counts;
                                                    for(sid in counts) {
                                                        for(cid in counts[sid]) {
                                                            var st = counts[sid][cid]['stacktrace'];
                                                            $('#'+oid+" pre").empty().append(st);
                                                            break;
                                                        }
                                                    }
                                                }
                                             })(oid)
                                    }); 
                                }
                            })(className)
                        });
                    }
                    
                },
                error: function(request, textStatus, errorThrown) {
                    $('#'+tdid).empty().append("Could not count retrieve count data"); 
                }
            });
            
            //if (c++==5) break;
        }
    }
    
    $(document).ready(function() {

	    var $tabs = $("#tabs").tabs();
	    
        $tabs.tabs({
            select: function(event, ui) {
                if (!$(ui.tab.hash).data('loaded')) {
                    createView(ui.tab.hash);
                }
           }
        });

        var someManagedAjax = $.manageAjax.create('ajaxman', {
            queue: true, 
            maxRequests: 5,
            cacheResponse: true 
        }); 
        
        $.ajaxSetup({timeout: 5000});
        
        $.ajax({ type:"GET", dataType: "json",               
                 url: GSS_JSON_URL+"/service",
                 success: function(json) {
                
                if (!("services" in json)) return;
                lastRefreshDate = json.lastRefreshDate;
                services = json.services;
                
                // generate some additional derived properties
                for(i in services) {
                    var service = services[i];
                    serviceById[service.id] = service;
                    service.display_name = service.simple_name || service.name;
                    service.title = service.display_name;
                    if (service.host_short_name) service.title += ' at ' + service.host_short_name;
                    var type = service["class"] == "DataService" ? "database" : "chart_bar";
                    service.img = '<img src="images/'+type+'.png" class="cellicon"/>';
                }
            
                if (allDataReady()) {
                    setup();
                }                    
                
            },
            error: function(request, textStatus, errorThrown) {
                $("#errors").append("<p>Could not count retrieve service data</p>"); 
            }
        });
    
        $.ajax({ type:"GET", dataType: "json",               
                 url: GSS_JSON_URL+"/host", 
                 success: function(json) {
                
                if (!("hosts" in json)) return;
                lastRefreshDate = json.lastRefreshDate;
                hosts = json.hosts;
                
                // Add a catchall host for services that don't have one
                var catchall = {};
                catchall.id = "";
                hosts.push(catchall);
                
                // generate some additional derived properties
                for(i in hosts) {
                    var host = hosts[i];
                    hostById[host.id] = host;
                    var imgsrc = host.image_name 
                        ? GSS_URL+'/image/host/'+host.image_name 
                        : 'images/house.png';
                    host.img = '<img src="'+imgsrc+'" class="cellicon"/>';
                    host.services = {};
                    host.services.DataService = [];
                    host.services.AnalyticalService = [];
                }
                
                if (allDataReady()) {
                    setup();
                }          
            },
            error: function(request, textStatus, errorThrown) {
                $("#errors").append("<p>Could not count retrieve host data</p>"); 
            }
        });
             
    });

</script>
<style type="text/css" media="screen">

body {
    background-color: #DCE6FA;
}

div.heading {
    font-size: 2em;
    font-family: verdana, sans-serif;
}

div.subheading {
    font-size: 1.2em;
    font-family: times new roman, serif;
    margin: -5px 0px 5px 0px;
}

img.typeicon {
    border-width: 0px;
    vertical-align: middle;
    margin-right: .5em;
}

img.cellicon {
    width: 16px;
    height: 16px;
}

.errors {
    color: red;
    font-size: 1em; 
    font-weight: bold
}

div.loading {
    font-size: 0.9em;
    padding: 2px;
}

div.refreshDate {
    margin-top: 2em;
    font-size: .8em;
    font-weight: bold;
}

table.grid {
    border-collapse: collapse;
}

table.grid {
    border: none;
    text-align: left;
}

table.grid td {
    border: 1px solid black;
    font-size: .8em;
    font-family: verdana, sans-serif;
}

.nowrap {
    white-space: nowrap;
}

table.grid td.nopad {
    padding: 0px;
    margin: 0px;
}

table.innergrid {
    padding: 0px;
    margin: 0px;
    border-collapse: collapse;
    border-width: 0px;
}

table.innergrid td {
    border-width: 0px;
    border-right: 1px solid black;
    text-align:center;
}

div.cell {
    width: 10px;
    height: 20px;
	cursor:pointer;
}

table.innergrid td.great {
    background-color: #32D929;
}

table.innergrid td.good {
    background-color: #2FAD28;
}

table.innergrid td.unknown {
    background-color: #B3B3B3;
}

table.innergrid td.nullresult {
    background-color: #998A15;
}

table.innergrid td.bad {
    background-color: #ED2B00;
}

/* tooltip styling */

.tooltip {
	display: none;
	max-width: 40em;
	background-color: #FAEEDC;
	padding: 2px;
	font-size: 11px;
	text-align: left;
	white-space: normal;
	word-wrap: break-word;
}

/* the overlayed element */
.overlay {
	display:none;
	z-index:10000;
	background-color:#fff;
	width:675px;
	padding: 10px;
	border:1px solid #666;
    opacity:0.8;
    -moz-border-radius:6px;
    -webkit-border-radius:6px;
    -moz-box-shadow: 0 0 50px #ccc;
    -webkit-box-shadow: 0 0 50px #ccc;	
}

/* close button positioned on upper right corner */
.overlay .close {
	background-image:url(images/close.png);
	position:absolute;
	right:-15px;
	top:-15px;
	cursor:pointer;
	height:35px;
	width:35px;
}

pre {
	overflow: auto;
	height: 300px;
}

div.serviceName {
    font-size: 1.1em;
    margin: 0px;
}

div.className {
    font-size: 1.1em;
    font-weight: bold;
    margin-bottom: 4px;
    padding-bottom: 4px;
    border-bottom: 2px dotted black;
}

span.tipvalue {
    font-size: 1.1em; 
    font-weight: bold
}


</style>
</head>
<body>



<div class="heading">State of the Grid</div>
<div class="subheading">The current health of caGrid services</div>

<div id="tabs">
	<ul>
		<li><a href="#DataService"><img src="images/database.png" class="typeicon">Data Services</a></li>
		<li><a href="#AnalyticalService"><img src="images/chart_bar.png" class="typeicon">Analytical Services</a></li>
	</ul>
	<div id="DataService">
		<div id="errors" class="errors"></div>
	</div>
	<div id="AnalyticalService">
		<p>Loading...</p>
	</div>
</div>

</body>
</html>